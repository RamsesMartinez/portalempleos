#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

# Wait for PostgreSQL to be ready
wait-for-it "${POSTGRES_HOST}:${POSTGRES_PORT}" -t 30

>&2 echo 'PostgreSQL is available'

# Run migrations
>&2 echo 'Running Django migrations...'
python /app/manage.py migrate --noinput

>&2 echo 'Migrations completed successfully'

# Optional: Create superuser if it doesn't exist
if [ -n "${DJANGO_SUPERUSER_EMAIL:-}" ] && [ -n "${DJANGO_SUPERUSER_PASSWORD:-}" ]; then
    >&2 echo 'Creating superuser if it does not exist...'
    python /app/manage.py shell << EOF
from django.contrib.auth import get_user_model
User = get_user_model()
if not User.objects.filter(email='${DJANGO_SUPERUSER_EMAIL}').exists():
    User.objects.create_superuser(
        username='${DJANGO_SUPERUSER_EMAIL}',
        email='${DJANGO_SUPERUSER_EMAIL}',
        password='${DJANGO_SUPERUSER_PASSWORD}'
    )
    print('Superuser created successfully')
else:
    print('Superuser already exists')
EOF
fi

>&2 echo 'Database setup completed'
